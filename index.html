<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta charset="UTF-8">
  <title>Pro-Forma Invoice Builder</title>

  <style>
    /* ========== PAGE & GLOBAL ========== */
    @page {
      size: A4;
      margin: 0;
    }

    * {
      box-sizing: border-box;
    }

    :root {
      --bg: #eef2f7;
      --panel: #ffffff;
      --panel-border: #e3e8ef;
      --text: #0f172a;
      --muted: #64748b;
      --brand: #2563eb;
      --brand-2: #7c3aed;
      --ok: #16a34a;
      --danger: #ef4444;
      --ring: 0 0 0 3px rgba(37, 99, 235, .15);
      --radius: 10px;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 18px;
      display: flex;
      gap: 20px;
      background: radial-gradient(1200px 600px at 0% 0%, #f8fafc 0%, var(--bg) 55%, #e9eef5 100%);
      color: var(--text);
    }

    input, textarea, select {
      width: 100%;
      padding: 9px 10px;
      margin-bottom: 8px;
      font-size: 13.5px;
      border: 1px solid var(--panel-border);
      border-radius: 8px;
      background: #f8fafc;
      transition: border .18s ease, box-shadow .18s ease, background .18s ease;
      outline: none;
    }

    input:hover, textarea:hover, select:hover {
      border-color: #cbd5e1;
      background: #ffffff;
    }

    input:focus, textarea:focus, select:focus {
      border-color: var(--brand);
      box-shadow: var(--ring);
      background: #ffffff;
    }

    label {
      font-weight: 800;
      font-size: 12px;
      display: block;
      margin-top: 8px;
      margin-bottom: 4px;
      color: var(--muted);
      letter-spacing: .02em;
      text-transform: uppercase;
    }

    /* ========== LEFT INPUT PANEL ========== */
    .form-container {
      width: 34%;
      background: var(--panel);
      border-radius: var(--radius);
      border: 1px solid var(--panel-border);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      height: fit-content;
      position: sticky;
      top: 12px;
    }

    .form-container h2 {
      font-size: 17px;
      margin: 0 0 12px 0;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-container h2::before {
      content: "ðŸ§¾";
      font-size: 18px;
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      background: #f1f5f9;
      padding: 6px;
      border-radius: 12px;
      border: 1px solid var(--panel-border);
    }

    .tab-btn {
      flex: 1;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 800;
      border: none;
      border-radius: 9px;
      cursor: pointer;
      background: transparent;
      color: var(--muted);
      transition: background .15s ease, color .15s ease, transform .12s ease;
      white-space: nowrap;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: #fff;
      box-shadow: 0 6px 14px rgba(37, 99, 235, .25);
    }

    .tab-btn:hover { transform: translateY(-1px); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .invoice-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
    }
    .invoice-grid .full {
      grid-column: 1 / -1;
    }
    @media (max-width: 700px) {
      .invoice-grid { grid-template-columns: 1fr; }
    }

    .section-title {
      margin-top: 14px;
      font-size: 12.5px;
      font-weight: 900;
      border-top: 1px dashed #e2e8f0;
      padding-top: 10px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      display: inline-block;
    }

    .line-items-wrapper {
      margin-top: 6px;
    }

    .line-item-row {
      display: grid;
      grid-template-columns: 1.8fr 0.8fr auto;
      gap: 6px;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .line-item-row textarea.desc {
      height: 56px;
      resize: vertical;
    }

    .line-item-row input.amt {
      text-align: right;
    }

    .add-btn {
      background: linear-gradient(135deg, var(--ok), #22c55e);
      color: white;
      font-size: 13.5px;
      font-weight: 800;
      gap: 6px;
      margin-top: 6px;
      box-shadow: 0 6px 14px rgba(34, 197, 94, .28);
    }

    .add-btn span { font-size: 15px; }
    .add-btn:hover { transform: translateY(-1px); filter: brightness(0.98); }

    .remove-btn {
      background: linear-gradient(135deg, var(--danger), #f97316);
      color: #fff;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      font-size: 14px;
      margin-top: 22px;
      box-shadow: 0 5px 10px rgba(239, 68, 68, .25);
    }

    .remove-btn:hover { transform: scale(1.05); }

    /* ========== PREVIEW / A4 INVOICE CONTAINER ========== */
    .preview-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .invoice-container {
      width: 210mm;
      min-height: 287mm;
      background: #ffffff;
      border: 1px solid #ccc;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      border-radius: 8px;
      padding: 14mm;
      display: flex;
      flex-direction: column;
    }

    .invoice-header { text-align: center; }

    .invoice-logo {
      max-width: 200px;
      max-height: 100px;
    }

    .company_name {
      font-size: 17px;
      font-weight: 700;
      margin-top: 8px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .customer-block {
      text-align: left;
      margin-top: 5mm;
      line-height: 1.45;
      font-size: 14px; /* unified size for customer block */
    }

    .customer-block strong {
      font-size: inherit; /* keep same size as other lines */
      font-weight: 700;
    }

    .invoice-title {
      margin-top: 5mm;
      font-weight: 700;
      font-size: 15px;
      text-align: left;
    }

    .invoice-main {
      flex: 1;
      margin-top: 6mm;
      font-size: 11px;
    }

    table { width: 100%; border-collapse: collapse; }

    .meta-table th, .meta-table td {
      border: 1px solid #000;
      padding: 4px 6px;
      font-size: 10.5px;
      text-align: left;
    }

    .meta-table th {
      background: #f2f2f2;
      font-weight: 700;
    }

    .items-table { margin-top: 8mm; }

    .items-table th, .items-table td {
      border: 1px solid #000;
      padding: 5px 6px;
      font-size: 11px;
    }

    .items-table th {
      background: #f2f2f2;
      font-weight: 700;
    }

    .items-table th.desc-col { width: 75%; }
    .items-table th.amount-col { width: 25%; text-align: right; white-space: nowrap; }

    .totals-box {
      width: 40%;
      margin-left: auto;
      margin-top: 10mm;
    }

    .totals-box table { border-collapse: collapse; }

    .totals-box th, .totals-box td {
      border: 1px solid #000;
      padding: 4px 6px;
      font-size: 11px;
    }

    .totals-box th {
      background: #f2f2f2;
      text-transform: uppercase;
    }

    .totals-box tr:last-child th,
    .totals-box tr:last-child td {
      font-weight: 700;
    }

    .disclaimer {
      padding-top: 10mm;
      font-size: 11px;
      line-height: 1.4;
      text-align: left;
    }


    .disclaimer p { margin: 0 0 2px 0; }

    .invoice-footer {
      margin-top: auto;
      text-align: center;
      font-size: 11px;
    }

    .footer-cheque {
      font-size: 9.5px;
      line-height: 1.35;
      text-align: center;
      margin-bottom: 3mm;
    }

    .footer-line {
      border-top: 1px solid #000;
      padding-top: 3mm;
    }

    /* ========== PRINT MODE ========== */
    @media print {
      body {
        margin: 0;
        padding: 0;
        display: block;
        background: #ffffff;
      }

      .form-container,
      .actions,
      .history-panel {
        display: none !important;
      }

      .invoice-container {
        width: 210mm !important;
        max-height: 297mm !important;
        padding: 18mm !important;
        border: none !important;
        box-shadow: none !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
      }

      * {
        page-break-inside: avoid !important;
        page-break-before: avoid !important;
        page-break-after: avoid !important;
      }
    }

    /* Actions */
    .actions {
      margin-top: 14px;
      align-self: flex-start;
    }

    .actions button {
      padding: 9px 18px;
      margin-right: 8px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 800;
      color: #fff;
      box-shadow: 0 8px 18px rgba(15, 23, 42, .15);
      transition: transform .15s ease, filter .15s ease;
    }

    .actions button:nth-child(1) { background: linear-gradient(135deg, var(--brand), #0ea5e9); }
    .actions button:nth-child(2) { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .actions button:nth-child(3) { background: linear-gradient(135deg, var(--brand-2), #ec4899); }

    .actions button:hover { transform: translateY(-1px); filter: brightness(0.98); }
    @media (max-width: 1100px) {
      body { flex-direction: column; }
      .form-container { width: 100%; position: static; }
      .preview-wrapper { width: 100%; }
      .invoice-container { transform: scale(0.98); transform-origin: top center; }
    }

    /* History panel */
    .history-panel {
      margin-top: 16px;
      align-self: stretch;
      background: #ffffff;
      border: 1px solid #d0d3da;
      border-radius: 8px;
      padding: 10px 12px;
      max-height: 260px;
      overflow-y: auto;
      font-size: 12px;
    }

    .history-panel h3 {
      margin: 0 0 8px 0;
      font-size: 13px;
    }

    .history-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .history-controls input[type="text"] {
      flex: 1;
      padding: 4px 6px;
      font-size: 12px;
    }

    .history-controls button,
    .import-label {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #e9ecef;
    }

    .history-controls button:hover,
    .import-label:hover {
      background: #dee2e6;
    }

    .import-label input[type="file"] {
      display: none;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-item span {
      margin-right: 8px;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-item button {
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #e9ecef;
      margin-left: 4px;
    }

    .history-item button:hover {
      background: #dee2e6;
    }
  </style>
</head>
<body>

  <!-- LEFT INPUT PANEL -->
  <div class="form-container">
    <h2>Invoice Inputs</h2>

    <div class="tabs">
      <button type="button" class="tab-btn active" data-tab="tab_customer">Customer Details</button>
      <button type="button" class="tab-btn" data-tab="tab_invoice">Invoice Details</button>
      <button type="button" class="tab-btn" data-tab="tab_charges">Charges & Items</button>
    </div>

    <div id="tab_customer" class="tab-content active">
      <label for="company_name_input">Company Name</label>
      <input id="company_name_input" value="Airwave Freight Pvt Ltd" oninput="updateInvoice()">

      <label for="customer_name">Customer Name</label>
      <input id="customer_name" oninput="updateInvoice()">

      <label for="customer_address_line1">Address Line 1</label>
      <input id="customer_address_line1" oninput="updateInvoice()">

      <label for="customer_address_line2">Address Line 2</label>
      <input id="customer_address_line2" oninput="updateInvoice()">

      <label for="customer_country">Country</label>
      <input id="customer_country" oninput="updateInvoice()">

      <label for="customer_phone">Customer Phone</label>
      <input id="customer_phone" oninput="updateInvoice()">

      <label for="customer_email">Customer Email</label>
      <input id="customer_email" oninput="updateInvoice()">
    </div> <!-- /tab_customer -->

    <div id="tab_invoice" class="tab-content">
      <div class="section-title">Invoice Details</div>
      <div class="invoice-grid">

    <label for="currency_selector" class="full">Currency</label>
    <select id="currency_selector" class="full" oninput="onCurrencyChange()">
      <option value="LKR">LKR</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="GBP">GBP</option>
      <option value="AED">AED</option>
      <option value="INR">INR</option>
      <option value="SGD">SGD</option>
      <option value="AUD">AUD</option>
      <option value="CAD">CAD</option>
      <option value="JPY">JPY</option>
      <option value="CNY">CNY</option>
    </select>

    <label for="invoice_number">Invoice Number</label>
    <input id="invoice_number" oninput="updateInvoice()">

    <label for="invoice_date">Date</label>
    <input type="date" id="invoice_date" oninput="updateInvoice()">

    <label for="due_date">Due Date</label>
    <input type="date" id="due_date" oninput="updateInvoice()">

    <label for="payment_terms">Payment Terms</label>
    <select id="payment_terms" oninput="updateInvoice()">
      <option value="">-- Select Payment Terms --</option>
      <option value="Due on Receipt">Due on Receipt</option>
      <option value="7 Days">7 Days</option>
      <option value="14 Days">14 Days</option>
      <option value="30 Days">30 Days</option>
      <option value="60 Days">60 Days</option>
    </select>

    <label for="payment_type">Payment Type</label>
    <select id="payment_type" oninput="updateInvoice()">
      <option value="Bank Transfer">Bank Transfer</option>
      <option value="Cheque">Cheque</option>
      <option value="Cash">Cash</option>
      <option value="Card">Card</option>
      <option value="Online Transfer">Online Transfer</option>
    </select>

    <label for="bank_name" class="full">Bank Name</label>
    <input id="bank_name" class="full" list="bank_name_list" oninput="updateInvoice()" placeholder="Start typing bank name...">
    <datalist id="bank_name_list">
      <option value="Alliance Finance Company PLC"></option>
      <option value="Amana Bank PLC"></option>
      <option value="Axis Bank"></option>
      <option value="Bank of Ceylon"></option>
      <option value="Cargills Bank Limited"></option>
      <option value="Central Finance PLC"></option>
      <option value="Citibank"></option>
      <option value="Citizen Development Business Finance PLC"></option>
      <option value="Commercial Bank PLC"></option>
      <option value="Commercial Credit & Finance PLC"></option>
      <option value="Commercial Leasing and Finance"></option>
      <option value="Deutsche Bank"></option>
      <option value="DFCC Bank PLC"></option>
      <option value="Habib Bank Ltd"></option>
      <option value="Hatton National Bank PLC"></option>
      <option value="HDFC Bank"></option>
      <option value="HSBC (Hongkong Shanghai Bank)"></option>
      <option value="ICICI Bank Ltd"></option>
      <option value="Indian Bank"></option>
      <option value="Indian Overseas Bank"></option>
      <option value="Lanka Orix Finance PLC"></option>
      <option value="LB Finance PLC"></option>
      <option value="MCB Bank Ltd"></option>
      <option value="National Development Bank PLC"></option>
      <option value="National Savings Bank"></option>
      <option value="Nations Trust Bank PLC"></option>
      <option value="Pan Asia Banking Corporation PLC"></option>
      <option value="People's Bank"></option>
      <option value="Peopleâ€™s Leasing & Finance PLC"></option>
      <option value="Public Bank"></option>
      <option value="Regional Development Bank"></option>
      <option value="Sampath Bank PLC"></option>
      <option value="Sanasa Development Bank"></option>
      <option value="Seylan Bank PLC"></option>
      <option value="Standard Chartered Bank"></option>
      <option value="State Bank of India"></option>
      <option value="Union Bank of Colombo PLC"></option>
      <option value="Vallibel Finance PLC"></option>
    </datalist>

    <label for="bank_branch" class="full">Bank Branch</label>
    <input id="bank_branch" class="full" list="bank_branch_list" oninput="updateInvoice()" placeholder="Start typing branch...">
    <datalist id="bank_branch_list"></datalist>

    <label for="bank_account" class="full">Bank A/C No</label>
    <input id="bank_account" class="full" oninput="updateInvoice()" placeholder="e.g., 123-456-7890">

    <label for="customer_vat">VAT / TRN / TIN</label>
    <input id="customer_vat" oninput="updateInvoice()">

    <label for="chargeable_weight">Chargeable Weight</label>
    <input id="chargeable_weight" oninput="updateInvoice()" placeholder="e.g., 125.50 KG">

    <label for="flight_no">Flight No</label>
    <input id="flight_no" oninput="updateInvoice()" placeholder="e.g., UL-XXX">

    <label for="flight_date">Flight Date</label>
    <input type="date" id="flight_date" oninput="updateInvoice()">

    <label for="mawb_number">MAWB Number</label>
    <input id="mawb_number" oninput="updateInvoice()">

      </div>

    <label for="invoice_reference" style="display:none;">Invoice Reference</label>
    <input id="invoice_reference" oninput="updateInvoice()" style="display:none;">
    </div> <!-- /tab_invoice -->

    <div id="tab_charges" class="tab-content">
      <div class="section-title">Charges & Tax</div>

      <label for="service_percent">Service Charge %</label>
      <input id="service_percent" type="number" step="0.01" value="0" oninput="updateInvoice()">

      <label for="vat_percent">VAT %</label>
      <input id="vat_percent" type="number" step="0.01" value="0" oninput="updateInvoice()">

      <div class="section-title">Line Items</div>

      <div id="items" class="line-items-wrapper"></div>

      <button class="add-btn" type="button" onclick="addItem()">
        <span>âž•</span> Add Line
      </button>
    </div> <!-- /tab_charges -->
  </div>

  <!-- RIGHT PREVIEW PANEL -->
  <div class="preview-wrapper">
    <div class="invoice-container" id="invoice_section">

      <!-- HEADER -->
      <div class="invoice-header">
        <img src="airwave-logo.png" alt="Company Logo" class="invoice-logo">
        <div class="company_name" id="company_name">
          Airwave Freight Pvt Ltd
        </div>
        <div class="customer-block" id="preview_customer"></div>
        <div class="invoice-title" id="preview_invoice_number">
          PRO-FORMA INVOICE
        </div>
      </div>

      <!-- MAIN BODY -->
      <div class="invoice-main">
        <!-- meta info table -->
        <table class="meta-table">
          <tr>
            <th>DATE</th>
            <th>DUE DATE</th>
            <th>CHARGEABLE WEIGHT</th>
            <th>FLIGHT NO</th>
            <th>FLIGHT DATE</th>
            <th>MAWB</th>
          </tr>
          <tr>
            <td id="p_date"></td>
            <td id="p_due"></td>
            <td id="p_cw"></td>
            <td id="p_flightno"></td>
            <td id="p_flight"></td>
            <td id="p_mawb"></td>
          </tr>
        </table>

        <!-- items table -->
        <table class="items-table" id="preview_items">
          <tr>
            <th class="desc-col">DESCRIPTION</th>
            <th class="amount-col">AMOUNT</th>
          </tr>
        </table>

        <!-- totals box -->
        <div class="totals-box">
          <table>
            <tr>
              <th>SUBTOTAL</th>
              <td id="subtotal">LKR 0.00</td>
            </tr>
            <tr>
              <th>SERVICE CHARGE</th>
              <td id="service_amount">LKR 0.00</td>
            </tr>
            <tr>
              <th>VAT</th>
              <td id="vat_amount">LKR 0.00</td>
            </tr>
            <tr>
              <th>TOTAL</th>
              <td id="total">LKR 0.00</td>
            </tr>
          </table>
        </div>
            <div style="margin-top:-23mm;font-size:11px;" id="payment_preview_block">
              <span id="p_terms_row"><strong>Payment Terms:</strong> <span id="p_terms"></span><br></span>
              <span id="p_type_row"><strong>Payment Type:</strong> <span id="p_type"></span><br></span>
              <span id="p_vat_row"><strong>VAT / TRN / TIN:</strong> <span id="p_vat_value"></span><br></span>
              <span id="p_bankname_row"><strong>Bank Name:</strong> <span id="p_bank_name"></span><br></span>
              <span id="p_branch_row"><strong>Branch:</strong> <span id="p_bank_branch"></span><br></span>
              <span id="p_bank_row"><strong>Bank A/C No:</strong> <span id="p_bank_account"></span></span>
            </div>

        

        <!-- disclaimer (matches PDF layout) -->
        <div class="disclaimer">
          <p>Please use the following communication for your payment:</p>
          <p>This is computer generated. no signature required.</p>
        </div>

      </div>

      <!-- FOOTER -->
      <div class="invoice-footer">
        <div id="cheque_text" class="footer-cheque"></div>
        <div class="footer-line">
          <strong id="footer_company_name">Airwave Freight Pvt Ltd</strong><br>
          No. 339/68 Sixty feet Road, Kattuwa, Negombo â€” Phone: 031 212 1334 â€” Email: airwavefreight.lk@gmail.com<br>
          <span id="footer_bank"></span>
        </div>
      </div>
    </div>

    <!-- ACTIONS + HISTORY -->
    <div class="actions">
      <button type="button" onclick="handlePrint()">Print / Save as PDF</button>
      <button type="button" onclick="saveInvoice()">Save Invoice</button>
      <button type="button" onclick="refreshPage()">New Invoice</button>
    </div>

    <div class="history-panel" id="history_panel">
      <h3>Saved Invoices</h3>
      <div class="history-controls">
        <input type="text" id="history_search" placeholder="Search by invoice or customer" oninput="renderHistory()">
        <button type="button" onclick="exportHistory()">Export</button>
        <label class="import-label">
          Import
          <input type="file" id="import_file" accept=".json" onchange="importHistory(event)">
        </label>
      </div>
      <div id="history_list"></div>
    </div>
  </div>

  <!-- ========= FIREBASE CLOUD SYNC (AUTO BACKUP + AUTO PULL) ========= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      setDoc,
      doc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAyGI0pCfcEbGQUOUiH8NA_Lh2z7D1n17U",
      authDomain: "airwave-invoice-app.firebaseapp.com",
      projectId: "airwave-invoice-app",
      storageBucket: "airwave-invoice-app.firebasestorage.app",
      messagingSenderId: "986262821736",
      appId: "1:986262821736:web:1e672b419a62ce78f5d4dd",
      measurementId: "G-KTD0VFV5LK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COL = "invoices";

    async function cloudPullHistory() {
      const snap = await getDocs(collection(db, COL));
      const list = [];
      snap.forEach(d => list.push(d.data()));
      list.sort((a,b)=> (a.saved_at||"").localeCompare(b.saved_at||""));
      return list;
    }

    async function cloudUpsertInvoice(inv) {
      const rawId = inv.invoice_number || inv.saved_at || String(Date.now());
      const safeId = String(rawId).replace(/\//g, "_");
      await setDoc(doc(db, COL, safeId), inv);
    }

    async function cloudDeleteInvoice(inv) {
      const rawId = inv.invoice_number || inv.saved_at;
      if (!rawId) return;
      const safeId = String(rawId).replace(/\//g, "_");
      await deleteDoc(doc(db, COL, safeId));
    }

    async function cloudReplaceHistory(all) {
      for (const inv of all) {
        await cloudUpsertInvoice(inv);
      }
    }

    window.cloudPullHistory = cloudPullHistory;
    window.cloudUpsertInvoice = cloudUpsertInvoice;
    window.cloudDeleteInvoice = cloudDeleteInvoice;
    window.cloudReplaceHistory = cloudReplaceHistory;
  </script>
  <script>
    let itemCounter = 0;
    const HISTORY_KEY = "invoice_history";

    // Tabs (left panel)
    function setupTabs() {
      const btns = document.querySelectorAll('.tab-btn');
      const tabs = document.querySelectorAll('.tab-content');
      btns.forEach(b => {
        b.addEventListener('click', () => {
          const id = b.getAttribute('data-tab');
          btns.forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          tabs.forEach(t => t.classList.remove('active'));
          const target = document.getElementById(id);
          if (target) target.classList.add('active');
        });
      });
    }
    let currentCurrency = "LKR";
    let exchangeRates = { LKR: 1 };

    // --- Offline Bank Branch Data (starter set).
    // You can extend this list anytime by pasting more branches.
    const BANK_BRANCHES = {
      "Commercial Bank PLC": [
        "Akkaraipattu","Akuressa","Aluthgama","Ambalangoda","Anuradhapura","Avissawella","Badulla","Bambalapitiya","Battaramulla","Batticaloa","Borella","Chilaw","City Office","Colombo 07","Dehiwala","Galle City","Gampaha","Hatton","Ja-Ela","Jaffna","Kadawatha","Kandy","Katunayake FTZ","Kegalle","Kiribathgoda","Kurunegala","Maharagama","Matara","Negombo","Nugegoda","Panadura","Pettah","Ratnapura","Wattala","Wellawatte"
      ],
      "Bank of Ceylon": [
        "Head Office","Colombo","Kandy","Galle","Kurunegala","Negombo","Jaffna","Anuradhapura","Badulla","Batticaloa","Matara","Ratnapura","Chilaw","Nugegoda","Panadura"
      ],
      "People's Bank": [
        "Head Office","Colombo","Kandy","Galle","Kurunegala","Negombo","Jaffna","Anuradhapura","Badulla","Batticaloa","Matara","Ratnapura","Chilaw","Nugegoda"
      ],
      "Hatton National Bank PLC": [
        "Head Office","Colombo 03","Colombo 07","Kandy","Galle","Kurunegala","Negombo","Jaffna","Nugegoda","Panadura","Wattala","Matara"
      ],
      "Sampath Bank PLC": [
        "Head Office","Colombo","Kandy","Galle","Kurunegala","Negombo","Jaffna","Nugegoda","Panadura","Wattala"
      ]
    };

    function updateBranchList(bankName) {
      const dl = document.getElementById('bank_branch_list');
      if (!dl) return;
      dl.innerHTML = '';
      const branches = BANK_BRANCHES[bankName];
      if (!branches) return;
      branches.forEach(br => {
        const opt = document.createElement('option');
        opt.value = br;
        dl.appendChild(opt);
      });
    }

    function addItem() {
      const id = ++itemCounter;
      const container = document.getElementById('items');

      const row = document.createElement('div');
      row.className = 'line-item-row';
      row.id = 'item_' + id;

      row.innerHTML = `
        <textarea class="desc" placeholder="Description" oninput="updateInvoice()"></textarea>
        <input class="amt" type="number" step="0.01" placeholder="Amount" oninput="updateInvoice()">
        <button type="button" class="remove-btn" onclick="removeItem(${id})">âœ–</button>
      `;

      container.appendChild(row);
      updateInvoice();
    }

    function removeItem(id) {
      const row = document.getElementById('item_' + id);
      if (row) {
        row.remove();
        updateInvoice();
      }
    }

    function getVal(id) {
      const el = document.getElementById(id);
      return el ? (el.value || '') : '';
    }

    function formatCurrency(value) {
      const val = isNaN(value) ? 0 : value;
      const rate = exchangeRates[currentCurrency] || (currentCurrency === 'LKR' ? 1 : null);
      let displayValue = val;
      if (rate && currentCurrency !== 'LKR') {
        displayValue = val * rate;
      }
      return currentCurrency + ' ' + displayValue.toFixed(2);
    }

    function onCurrencyChange() {
      const sel = document.getElementById('currency_selector');
      if (!sel) return;
      currentCurrency = sel.value || 'LKR';
      updateInvoice();
    }

    async function fetchExchangeRates() {
      try {
        const res = await fetch('https://api.exchangerate.host/latest?base=LKR');
        if (!res.ok) return;
        const data = await res.json();
        if (data && data.rates) {
          exchangeRates = Object.assign({ LKR: 1 }, data.rates);
          updateInvoice();
        }
      } catch (e) {
        console.error('Failed to fetch exchange rates', e);
      }
    }

    function updateInvoice() {
      // company name
      const companyName = getVal('company_name_input') || 'Airwave Freight Pvt Ltd';
      document.getElementById('company_name').textContent = companyName;

      // cheque / disputes note (uses current company name)
      const chequeNote = `CHEQUES SHOULD BE DRAWN IN FAVOUR OF "${companyName}" AND CROSSED "ACCOUNT PAYEE". ANY DISPUTES ON THE CONTENTS OF THE INVOICE SHOULD BE COMMUNICATED TO ${companyName} IMMEDIATELY. INTEREST AT THE RATE OF 2% PER MONTH WILL BE LEVIED IF SETTLEMENT IS NOT EFFECTED WITHIN DUE DATE OF INVOICE.`;
      const chequeEl = document.getElementById('cheque_text');
      if (chequeEl) chequeEl.textContent = chequeNote;

      // footer dynamic company + bank account
      const bankAcc = getVal('bank_account');
      const footerNameEl = document.getElementById('footer_company_name');
      if (footerNameEl) footerNameEl.textContent = companyName;
      const footerBankEl = document.getElementById('footer_bank');
      if (footerBankEl) footerBankEl.textContent = bankAcc ? `Bank A/C No: ${bankAcc}` : '';

      // customer block
      const vat = getVal('customer_vat');
      const cphone = getVal('customer_phone');
      const cemail = getVal('customer_email');
      document.getElementById('preview_customer').innerHTML = `
        <strong>${getVal('customer_name')}</strong><br>
        ${getVal('customer_address_line1')}<br>
        ${getVal('customer_address_line2')}<br>
        ${getVal('customer_country')}
        ${cphone ? `<br><strong>Phone:</strong> ${cphone}` : ''}
        ${cemail ? `<br><strong>Email:</strong> ${cemail}` : ''}
      `;

      // title line
      const invNum = getVal('invoice_number');
      document.getElementById('preview_invoice_number').textContent =
        invNum
          ? 'PRO-FORMA INVOICE NUMBER - ' + invNum
          : 'PRO-FORMA INVOICE';

      // meta
      document.getElementById('p_date').textContent   = getVal('invoice_date');
      document.getElementById('p_due').textContent    = getVal('due_date');
      document.getElementById('p_cw').textContent     = getVal('chargeable_weight');
      document.getElementById('p_flightno').textContent = getVal('flight_no');
      document.getElementById('p_flight').textContent = getVal('flight_date');
      document.getElementById('p_mawb').textContent   = getVal('mawb_number');
      const termsVal = getVal('payment_terms');
      const typeVal  = getVal('payment_type');
      const vatVal   = getVal('customer_vat');
      const bankNameVal = getVal('bank_name');
      // update datalist options based on selected bank
      updateBranchList(bankNameVal);
      const bankBranchVal = getVal('bank_branch');
      const bankVal  = getVal('bank_account');

      // Payment Terms row
      document.getElementById('p_terms').textContent = termsVal;
      const termsRow = document.getElementById('p_terms_row');
      if (termsRow) termsRow.style.display = termsVal ? 'inline' : 'none';

      // Payment Type row
      document.getElementById('p_type').textContent = typeVal;
      const typeRow = document.getElementById('p_type_row');
      if (typeRow) typeRow.style.display = typeVal ? 'inline' : 'none';

      // VAT/TRN/TIN row (only here)
      const vatRow = document.getElementById('p_vat_row');
      const pVatEl = document.getElementById('p_vat_value');
      if (pVatEl) pVatEl.textContent = vatVal;
      if (vatRow) vatRow.style.display = vatVal ? 'inline' : 'none';

      // Bank Name row
      const bankNameRow = document.getElementById('p_bankname_row');
      const pBankNameEl = document.getElementById('p_bank_name');
      if (pBankNameEl) pBankNameEl.textContent = bankNameVal;
      if (bankNameRow) bankNameRow.style.display = bankNameVal ? 'inline' : 'none';

      // Bank Branch row
      const branchRow = document.getElementById('p_branch_row');
      const pBranchEl = document.getElementById('p_bank_branch');
      if (pBranchEl) pBranchEl.textContent = bankBranchVal;
      if (branchRow) branchRow.style.display = bankBranchVal ? 'inline' : 'none';

      // Bank A/C row
      document.getElementById('p_bank_account').textContent = bankVal;
      const bankRow = document.getElementById('p_bank_row');
      if (bankRow) bankRow.style.display = bankVal ? 'inline' : 'none';


      // line items + totals
      let rowsHtml = `
        <tr>
          <th class="desc-col">DESCRIPTION</th>
          <th class="amount-col">AMOUNT</th>
        </tr>
      `;

      let subtotal = 0;

      const descs = document.querySelectorAll('.line-item-row .desc');
      const amts  = document.querySelectorAll('.line-item-row .amt');

      for (let i = 0; i < descs.length; i++) {
        const d = descs[i].value;
        const val = parseFloat(amts[i].value) || 0;
        subtotal += val;

        rowsHtml += `
          <tr>
            <td class="desc-col">${d.replace(/\n/g, '<br>')}</td>
            <td class="amount-col">${formatCurrency(val)}</td>
          </tr>
        `;
      }

      const servicePercent = parseFloat(getVal('service_percent')) || 0;
      const vatPercent = parseFloat(getVal('vat_percent')) || 0;

      const serviceAmount = subtotal * (servicePercent / 100);
      const baseForVat = subtotal + serviceAmount;
      const vatAmount = baseForVat * (vatPercent / 100);
      const total = subtotal + serviceAmount + vatAmount;

      document.getElementById('preview_items').innerHTML = rowsHtml;
      document.getElementById('subtotal').textContent = formatCurrency(subtotal);
      document.getElementById('service_amount').textContent = formatCurrency(serviceAmount);
      document.getElementById('vat_amount').textContent = formatCurrency(vatAmount);
      document.getElementById('total').textContent    = formatCurrency(total);
      document.getElementById('amount_words').textContent = numberToWordsWithCents(total);

    }
    function numberToWordsWithCents(num) {
      if (isNaN(num)) return '';
      const whole = Math.floor(num);
      const cents = Math.round((num - whole) * 100);
      const words = toWords(whole);
      if (cents > 0) {
        return `${words} and ${cents}/100`;
      }
      return words;
    }

    function toWords(n) {
      const a = ['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
      const b = ['', '', 'Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
      if (n === 0) return 'Zero';
      if (n < 20) return a[n];
      if (n < 100) return b[Math.floor(n/10)] + (n%10? ' ' + a[n%10] : '');
      if (n < 1000) return a[Math.floor(n/100)] + ' Hundred' + (n%100? ' ' + toWords(n%100) : '');
      if (n < 1000000) return toWords(Math.floor(n/1000)) + ' Thousand' + (n%1000? ' ' + toWords(n%1000) : '');
      if (n < 1000000000) return toWords(Math.floor(n/1000000)) + ' Million' + (n%1000000? ' ' + toWords(n%1000000) : '');
      return toWords(Math.floor(n/1000000000)) + ' Billion' + (n%1000000000? ' ' + toWords(n%1000000000) : '');
    }

    function loadHistoryFromStorage() {
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) return [];
      try {
        return JSON.parse(raw);
      } catch (e) {
        console.error("Failed to parse invoice history", e);
        return [];
      }
    }

    function saveHistoryToStorage(list) {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(list));
    }

    function getCurrentInvoiceData() {
      const descs = document.querySelectorAll('.line-item-row .desc');
      const amts = document.querySelectorAll('.line-item-row .amt');
      const items = [];
      for (let i = 0; i < descs.length; i++) {
        items.push({
          description: descs[i].value,
          amount: parseFloat(amts[i].value) || 0
        });
      }
      return {
        company_name: getVal('company_name_input'),
        bank_account: getVal('bank_account'),
        bank_name: getVal('bank_name'),
        bank_branch: getVal('bank_branch'),
        customer_name: getVal('customer_name'),
        address1: getVal('customer_address_line1'),
        address2: getVal('customer_address_line2'),
        country: getVal('customer_country'),
        invoice_number: getVal('invoice_number'),
        invoice_date: getVal('invoice_date'),
        due_date: getVal('due_date'),
        chargeable_weight: getVal('chargeable_weight'),
        flight_no: getVal('flight_no'),
        payment_terms: getVal('payment_terms'),
        payment_type: getVal('payment_type'),
        customer_vat: getVal('customer_vat'),
        customer_phone: getVal('customer_phone'),
        customer_email: getVal('customer_email'),
        invoice_reference: getVal('invoice_reference'),
        flight_date: getVal('flight_date'),
        mawb_number: getVal('mawb_number'),
        items,
        service_percent: parseFloat(getVal('service_percent')) || 0,
        vat_percent: parseFloat(getVal('vat_percent')) || 0,
        currency: currentCurrency,
        subtotal: document.getElementById('subtotal').textContent,
        total: document.getElementById('total').textContent,
        saved_at: new Date().toISOString(),
      };
    }

    function renderHistory() {
      const list = loadHistoryFromStorage();
      const container = document.getElementById('history_list');
      if (!container) return;
      if (!list || list.length === 0) {
        container.innerHTML = '<div style="font-size:12px;color:#666;">No saved invoices yet.</div>';
        return;
      }
      const searchInput = document.getElementById('history_search');
      const term = (searchInput ? searchInput.value : '').toLowerCase();
      const filtered = list.filter(inv => {
        const invNum = (inv.invoice_number || '').toLowerCase();
        const cust = (inv.customer_name || '').toLowerCase();
        return !term || invNum.includes(term) || cust.includes(term);
      });
      if (filtered.length === 0) {
        container.innerHTML = '<div style="font-size:12px;color:#666;">No matching invoices.</div>';
        return;
      }
      const rows = filtered.map(inv => {
        const label = `${inv.invoice_number || 'No Number'} â€” ${inv.customer_name || 'No Customer'} â€” ${inv.total || ''}`;
        const originalIndex = list.indexOf(inv);
        return `
          <div class="history-item">
            <span>${label}</span>
            <button type="button" onclick="loadInvoice(${originalIndex})">Load</button>
            <button type="button" onclick="deleteInvoice(${originalIndex})">Delete</button>
          </div>
        `;
      }).join('');
      container.innerHTML = rows;
    }

    function saveInvoice() {
      const inv = getCurrentInvoiceData();
      const list = loadHistoryFromStorage();
      list.push(inv);
      saveHistoryToStorage(list);
      renderHistory();

      // âœ… CLOUD AUTO BACKUP
      if (window.cloudUpsertInvoice) window.cloudUpsertInvoice(inv);

      alert('Invoice saved.');
      // refresh to load a clean new invoice
      refreshPage();
    }
    function refreshPage() {
      location.reload();
    }

    function handlePrint() {
      window.print();
    }

    // after print dialog closes, refresh page
    window.addEventListener('afterprint', () => {
      refreshPage();
    });

    function clearLineItems() {
      const container = document.getElementById('items');
      container.innerHTML = '';
      itemCounter = 0;
    }

    function loadInvoice(index) {
      const list = loadHistoryFromStorage();
      const inv = list[index];
      if (!inv) return;

      document.getElementById('company_name_input').value = inv.company_name || '';
      document.getElementById('bank_account').value = inv.bank_account || '';
      document.getElementById('bank_name').value = inv.bank_name || '';
      document.getElementById('bank_branch').value = inv.bank_branch || '';
      document.getElementById('customer_name').value = inv.customer_name || '';
      document.getElementById('customer_address_line1').value = inv.address1 || '';
      document.getElementById('customer_address_line2').value = inv.address2 || '';
      document.getElementById('customer_country').value = inv.country || '';
      document.getElementById('invoice_number').value = inv.invoice_number || '';
      document.getElementById('invoice_date').value = inv.invoice_date || '';
      document.getElementById('due_date').value = inv.due_date || '';
      document.getElementById('chargeable_weight').value = inv.chargeable_weight || '';
      document.getElementById('flight_no').value = inv.flight_no || '';
      document.getElementById('payment_terms').value = inv.payment_terms || '';
      document.getElementById('customer_vat').value = inv.customer_vat || '';
      document.getElementById('customer_phone').value = inv.customer_phone || '';
      document.getElementById('customer_email').value = inv.customer_email || '';
      document.getElementById('invoice_reference').value = inv.invoice_reference || '';
      document.getElementById('flight_date').value = inv.flight_date || '';
      document.getElementById('mawb_number').value = inv.mawb_number || '';

      document.getElementById('service_percent').value = inv.service_percent || 0;
      document.getElementById('vat_percent').value = inv.vat_percent || 0;
      document.getElementById('payment_type').value = inv.payment_type || 'Bank Transfer';


      if (inv.currency) {
        currentCurrency = inv.currency;
        const sel = document.getElementById('currency_selector');
        if (sel) sel.value = inv.currency;
      }

      clearLineItems();
      if (inv.items && inv.items.length) {
        inv.items.forEach(it => {
          const id = ++itemCounter;
          const container = document.getElementById('items');
          const row = document.createElement('div');
          row.className = 'line-item-row';
          row.id = 'item_' + id;
          row.innerHTML = `
            <textarea class="desc" placeholder="Description" oninput="updateInvoice()">${it.description || ''}</textarea>
            <input class="amt" type="number" step="0.01" placeholder="Amount" value="${it.amount || 0}" oninput="updateInvoice()">
            <button type="button" class="remove-btn" onclick="removeItem(${id})">âœ–</button>
          `;
          container.appendChild(row);
        });
      } else {
        addItem();
      }
      updateInvoice();
    }


    function deleteInvoice(index) {
      const list = loadHistoryFromStorage();
      if (!list || !list.length) return;

      const inv = list[index];
      list.splice(index, 1);
      saveHistoryToStorage(list);
      renderHistory();

      // âœ… CLOUD DELETE
      if (window.cloudDeleteInvoice) window.cloudDeleteInvoice(inv);
    }

    function exportHistory() {
      const list = loadHistoryFromStorage();
      const blob = new Blob([JSON.stringify(list || [], null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'invoice_history_backup.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importHistory(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result || '[]');
          if (Array.isArray(data)) {
            saveHistoryToStorage(data);
            renderHistory();

            // âœ… CLOUD REPLACE / MERGE
            if (window.cloudReplaceHistory) window.cloudReplaceHistory(data);

            alert('Invoice history imported.');
          } else {
            alert('Invalid history file format.');
          }
        } catch (err) {
          console.error('Failed to import history', err);
          alert('Failed to import history.');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function getNextInvoiceNumber() {
      let storedYear = localStorage.getItem("invoice_year");
      let storedNumber = localStorage.getItem("invoice_no");
      const currentYear = new Date().getFullYear();

      if (storedYear != currentYear) {
        storedYear = currentYear;
        storedNumber = 1;
      } else {
        storedNumber = storedNumber ? parseInt(storedNumber) + 1 : 1;
      }

      localStorage.setItem("invoice_year", storedYear);
      localStorage.setItem("invoice_no", storedNumber);

      return `Airwave/${storedYear}/${String(storedNumber).padStart(5, "0")}`;
    }

    // on load
    addEventListener("DOMContentLoaded", async () => {
      setupTabs();
      const bankNameInput = document.getElementById('bank_name');
      if (bankNameInput) {
        bankNameInput.addEventListener('input', () => {
          document.getElementById('bank_branch').value = '';
          updateBranchList(bankNameInput.value);
          updateInvoice();
        });
      }
      document.getElementById("invoice_number").value = getNextInvoiceNumber();
      addItem();
      updateInvoice();
      renderHistory();
      fetchExchangeRates();

      // âœ… AUTO PULL FROM CLOUD (any PC)
      if (window.cloudPullHistory) {
        try {
          const cloudList = await window.cloudPullHistory();
          if (cloudList && cloudList.length) {
            saveHistoryToStorage(cloudList);
            renderHistory();
          }
        } catch (e) {
          console.log("Cloud pull failed (offline maybe). Using local history.");
        }
      }
    });
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>

</body>
</html>